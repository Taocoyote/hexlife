<!doctype html>
<html>
<head>
<title>hexlife</title>
<meta http-equiv="content-type" content="text/html;charset=utf-8" />
</head>
<body>

<button id="startbutton">Start</button>
<button id="stopbutton">Pause</button>
<button id="nextbutton">Next</button>

<canvas id="canvas" width="500" height="500"></canvas>

<script type="text/javascript">

    function drawHex(cxt, size, x, y)
    {
        var numberOfSides = 6,
            size = size,
            Xcenter = x,
            Ycenter = y;

        cxt.beginPath();
        cxt.moveTo (Xcenter + size * Math.cos(0), Ycenter + size *  Math.sin(0));          

        for (var i = 1; i <= numberOfSides;i += 1) {
            cxt.lineTo (Xcenter + size * Math.cos(i * 2 * Math.PI / numberOfSides), Ycenter + size * Math.sin(i * 2 * Math.PI / numberOfSides));
        }

        cxt.strokeStyle = "#000000";
        cxt.lineWidth = 1;
        cxt.stroke();
    }

    var filledHexImage = new Image();
    filledHexImage.onload = function() {
    };

    var emptyHexImage = new Image();
    emptyHexImage.onload = function() {
    };

    var highlightHexImage = new Image();
    highlightHexImage.onload = function() {
    };


    filledHexImage.src = "images/filledhex.png";
    emptyHexImage.src = "images/emptyhex.png";
    highlightHexImage.src = "images/highlighthex.png";

    var body = document.body,
    html = document.documentElement;

    var height = Math.max( body.scrollHeight, body.offsetHeight, 
                       html.clientHeight, html.scrollHeight, html.offsetHeight );
    var width = Math.max( body.scrollWidth, body.offsetWidth, 
                       html.clientWidth, html.scrollWidth, html.offsetWidth );

    x = 0;
    y = 0;
    z = 0;
    w = width;
    h = height;
    var canvas = document.getElementById('canvas');
    var context = canvas.getContext("2d");
    canvas.width = w;
    canvas.height = h;
    canvas.style.width = w+"px";
    canvas.style.height = h+"px";
    canvas.style.position = "absolute";
    canvas.style.left = x+"px";
    canvas.style.top = y+"px";
    canvas.style.zIndex = z;

    var startbutton = document.getElementById('startbutton');
    startbutton.style.position = "absolute";
    startbutton.style.left = 20+"px";
    startbutton.style.top = 440+"px";
    startbutton.style.zIndex = 10;

    var stopbutton = document.getElementById('stopbutton');
    stopbutton.style.position = "absolute";
    stopbutton.style.left = 70+"px";
    stopbutton.style.top = 440+"px";
    stopbutton.style.zIndex = 10;

    var nextbutton = document.getElementById('nextbutton');
    nextbutton.style.position = "absolute";
    nextbutton.style.left = 130+"px";
    nextbutton.style.top = 440+"px";
    nextbutton.style.zIndex = 10;

    var boardw = 80;
    var boardh = 30;

    var board = [];

    var i=0,j=0;
    for(i=0; i<boardw; i++)
    {
        board[i] = [];
        for(j=0; j<boardh; j++)
        {
            board[i][j] = (i*j)%2;
        }
    }

    var highlight = {x: 0, y: 0};

    function pixelToTile(px, py, boardw, boardh)
    {
        var tiley = Math.floor((py - 5) / 14);
        var tilex = Math.floor((px - (tiley % 2) * 8) / 16);

        var x = tilex * 16 + (tiley % 2) * 8;
        var y = tiley * 14;

        if (tilex >= 0 && tilex < boardw && 
            tiley >= 0 && tiley < boardh)
        {
            return {x: x, y: y, tilex: tilex, tiley: tiley};
        }

    }

    var buttonDown = false;

    function placeCell(x,y,boardw, boardh)
    {
        highlight = pixelToTile(x, y, boardw, boardh);
        if (highlight)
        {
            board[highlight.tilex][highlight.tiley] = 1;
        }
    }

    canvas.addEventListener('mousedown', function(evt)
    {
        buttonDown = true;
        placeCell(evt.x, evt.y, boardw, boardh);

    }, false);

    canvas.addEventListener('mouseup', function(evt)
    {
        buttonDown = false;
    }, false);

    canvas.addEventListener('mousemove', function(evt)
    {
        highlight = pixelToTile(evt.x, evt.y, boardw, boardh);
        if (buttonDown)
        {
            placeCell(evt.x, evt.y, boardw, boardh);
        }

    }, false);


    function getAdjacentCells(cellX, cellY, boardw, boardh)
    {
        var adjList = [];
        if (cellY % 2)
        {
            adjList = [
                {x: cellX    , y: cellY - 1},
                {x: cellX - 1, y: cellY    },
                {x: cellX    , y: cellY + 1},
                {x: cellX + 1, y: cellY - 1},
                {x: cellX + 1, y: cellY    },
                {x: cellX + 1, y: cellY + 1}
            ]
        }
        else
        {
            adjList = [
                {x: cellX - 1, y: cellY - 1},
                {x: cellX - 1, y: cellY    },
                {x: cellX - 1, y: cellY + 1},
                {x: cellX    , y: cellY - 1},
                {x: cellX + 1, y: cellY    },
                {x: cellX    , y: cellY + 1}
            ]
        }
        var filtered = [];
        var i = 0;
        for (i=0; i<adjList.length; i++)
        {
            if (adjList[i].x >= 0 && adjList[i].x < boardw && 
                adjList[i].y >= 0 && adjList[i].y < boardh)
            {
                filtered.push(adjList[i]);
            }
        }
        return filtered;
    }

    var update = true;
    var refresher = false;

    startbutton.addEventListener('click', function(evt)
    {
        if (!refresher)
        {
            refresher = setInterval(function()
            {
                update = true;
            }, 100);
        }
    }, false);

    stopbutton.addEventListener('click', function(evt)
    {
        if (refresher)
        {
            clearInterval(refresher);
            refresher = false;
        }
    }, false);

    nextbutton.addEventListener('click', function(evt)
    {
        update = true;
    }, false);

    setInterval(function()
    {
        context.fillStyle = "#000";
        context.fillRect(0, 0, w, h);

        if (highlight)
        {
            context.drawImage(highlightHexImage, highlight.x, highlight.y);
        }

        if (update)
        {
            // update
            var newBoard = [];
            for(i=0; i<boardw; i++)
            {
                newBoard[i] = [];
                for(j=0; j<boardh; j++)
                {
                    var adj = getAdjacentCells(i,j,boardw, boardh);
                    var cellIdx = 0;
                    var count = 0;
                    for(cellIdx=0; cellIdx < adj.length; cellIdx++)
                    {
                        count += board[adj[cellIdx].x][adj[cellIdx].y];
                    }

                    if (board[i][j])
                    {
                        if (count == 3 || count == 4)
                        {
                            // stay alive
                            newBoard[i][j] = 1;
                        }
                        else
                        {
                            // die
                            newBoard[i][j] = 0;
                        }
                    }
                    else
                    {
                        if (count == 2)
                        {
                            // born
                            newBoard[i][j] = 1;
                        }
                        else
                        {
                            // stay dead
                            newBoard[i][j] = 0;
                        }
                    }
                }
            }
            board = newBoard;
            update = false;
        }
        // render
        var i=0,j=0;
        for(i=0; i<boardw; i++)
        {
            for(j=0; j<boardh; j++)
            {
                var x = i * 16 + (j % 2) * 8;
                var y = j * 14;
                var hex = emptyHexImage;
                if (board[i][j])
                {
                    hex = filledHexImage;
                }
                context.drawImage(hex, x, y);
            }
        }
        
    }, 16)

</script>


</body>
</html>
